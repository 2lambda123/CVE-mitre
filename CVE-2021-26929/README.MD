An XSS issue was discovered in Horde Groupware Webmail Edition through 5.2.22 (where the Horde_Text_Filter library before 2.3.7 is used). The attacker can send a plain text e-mail message, with JavaScript encoded as a link or email that is mishandled by preProcess in Text2html.php, because bespoke use of \x00\x00\x00 and \x01\x01\x01 interferes with XSS defenses.

[source](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-26929)

## Details
The issues can be found in /usr/share/php/Horde/Text/Filter/Text2html.php in the preProcess method of the Horde_Text_Filter_Text2html class. The method first looks for URLs and emails within the message and then replaces them with their base64 encoded value surrounded by a specific sentinel (“\x00\x00\x00” in the case of URLs, and “\x01\x01\x01” in the case of emails). This operation is likely performed to escape the htmlspecialchars call on the message that can be seen at [1].
```
$text2 = @htmlspecialchars($text, ENT_COMPAT, $this->_params['charset']); // 1
// ...
$text = $text2;
/* Do in-lining of http://xxx.xxx to link, xxx@xxx.xxx to email. */
if ($this->_params['parselevel'] < self::NOHTML) {
  $text = Horde_Text_Filter_Linkurls::decode($text); // 2 
  if ($this->_params['parselevel'] < self::MICRO_LINKURL) {
    $text = Horde_Text_Filter_Emails::decode($text); // 3 
  }
  if ($this->_params['space2html']) {
    $params = reset($this->_params['space2html']); $driver = key($this->_params['space2html']);
  } else {
    $driver = 'space2html'; $params = array();
  }
  $text = Horde_Text_Filter::filter($text, $driver, $params); 
}
```
Stored XSS via in-line URLs
At [2] it can be seen that the decode method of the Horde_Text_Filter_Linkurls class is called with the message as the first parameter. The relevant code can be seen below:
```
public static function decode($text)
{
  return preg_replace_callback(
    '/\00\00\00([\w=+\/]*)\00\00\00/', 
    function($hex) {
      return base64_decode($hex[1]); 
    },
    $text); 
}
```
As it can be seen above the method searches and replaces any instance of base64 values surrounded by the “\x00\x00\x00” sentinel with it’s base64 decoded value. Such functionality can be used to decode arbitrary base64 within the message, bypassing htmlspecialchars.

Stored XSS via in-line emails
A similar issue also affects emails found within a message. At [3] it can be seen that the decode method of the Horde_Text_Filter_Emails class with the message as the first parameter. The relevant code can be seen below:
```
public static function decode($text) 
{
  return preg_replace_callback(
    '/\01\01\01([\w=+\/]*)\01\01\01/', 
    function($hex) {
      return base64_decode($hex[1]);
    },
    $text); 
}
```
As it can be seen above, almost the exact code is used to for in-line emails, as for in-line URLs, with the exception that in this case the sentinel is “\x01\x01\x01”.
